<div class="page-shell">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Payments</h2>
    <button type="button" class="btn btn-primary" (click)="openCreateModal()">Record Payment</button>
  </div>

  <div class="card-shell mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Filter</label>
        <input class="form-control" [(ngModel)]="filter" placeholder="Reference number" />
      </div>

      <div class="col-md-3">
        <label class="form-label">Method</label>
        <select class="form-select" [(ngModel)]="methodFilter">
          <option [ngValue]="undefined">All methods</option>
          <option *ngFor="let option of methodOptions" [ngValue]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <div class="col-md-3">
        <button type="button" class="btn btn-outline-primary me-2" (click)="pageIndex = 0; load()">Apply</button>
        <button type="button" class="btn btn-outline-secondary" (click)="filter = ''; methodFilter = undefined; pageIndex = 0; load()">
          Reset
        </button>
      </div>
    </div>
  </div>

  <app-loading-state *ngIf="isLoading" message="payments"></app-loading-state>
  <app-error-state *ngIf="hasError" (retry)="load()"></app-error-state>

  <app-empty-state
    *ngIf="!isLoading && !hasError && payments.length === 0"
    message="No payments found for this filter">
  </app-empty-state>

  <div class="card-shell table-responsive" *ngIf="!isLoading && !hasError && payments.length > 0">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>Reference</th>
          <th>Invoice Id</th>
          <th>Method</th>
          <th>Amount</th>
          <th>Paid At</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let payment of payments; trackBy: trackByPayment">
          <td class="fw-semibold">{{ payment.referenceNumber }}</td>
          <td><code>{{ payment.invoiceId }}</code></td>
          <td>{{ methodLabel(payment.method) }}</td>
          <td>${{ payment.amount | number: '1.0-2' }}</td>
          <td>{{ payment.paidAt | date: 'medium' }}</td>
          <td class="text-end">
            <button type="button" class="btn btn-outline-primary btn-sm me-1" (click)="openEditModal(payment)">Edit</button>
            <button type="button" class="btn btn-outline-danger btn-sm" (click)="delete(payment)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end mt-3" *ngIf="!isLoading && !hasError && totalCount > pageSize">
    <button type="button" class="btn btn-sm btn-light me-1" (click)="onPageChanged(-1)">Prev</button>
    <button type="button" class="btn btn-sm btn-light" (click)="onPageChanged(1)">Next</button>
  </div>
</div>

<div class="modal d-block" tabindex="-1" *ngIf="modalVisible">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editingPaymentId ? 'Edit Payment' : 'Record Payment' }}</h5>
        <button type="button" class="btn-close" [disabled]="isSaving" (click)="closeModal()"></button>
      </div>

      <form [formGroup]="form" (ngSubmit)="save()">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Invoice Id</label>
              <input class="form-control" formControlName="invoiceId" placeholder="GUID" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Reference Number</label>
              <input class="form-control" formControlName="referenceNumber" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Method</label>
              <select class="form-select" formControlName="method">
                <option *ngFor="let option of methodOptions" [ngValue]="option.value">{{ option.label }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Amount</label>
              <input class="form-control" type="number" min="0" formControlName="amount" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Paid At</label>
              <input class="form-control" type="datetime-local" formControlName="paidAt" />
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" [disabled]="isSaving" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="isSaving">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
