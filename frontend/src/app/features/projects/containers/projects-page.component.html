<div class="page-shell">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Projects</h2>
    <button type="button" class="btn btn-primary" (click)="openCreateModal()">New Project</button>
  </div>

  <div class="card-shell mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Filter</label>
        <input class="form-control" [(ngModel)]="filter" placeholder="Search by project name or description" />
      </div>

      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select class="form-select" [(ngModel)]="statusFilter">
          <option [ngValue]="undefined">All statuses</option>
          <option *ngFor="let option of statusOptions" [ngValue]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <div class="col-md-3">
        <button type="button" class="btn btn-outline-primary me-2" (click)="pageIndex = 0; load()">Apply</button>
        <button type="button" class="btn btn-outline-secondary" (click)="filter = ''; statusFilter = undefined; pageIndex = 0; load()">
          Reset
        </button>
      </div>
    </div>
  </div>

  <app-loading-state *ngIf="isLoading" message="projects"></app-loading-state>
  <app-error-state *ngIf="hasError" (retry)="load()"></app-error-state>

  <app-empty-state
    *ngIf="!isLoading && !hasError && projects.length === 0"
    message="No projects found for this filter">
  </app-empty-state>

  <div class="card-shell table-responsive" *ngIf="!isLoading && !hasError && projects.length > 0">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Customer Id</th>
          <th>Status</th>
          <th>Budget</th>
          <th>Start</th>
          <th>End</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let project of projects; trackBy: trackByProject">
          <td>
            <div class="fw-semibold">{{ project.name }}</div>
            <small class="text-muted">{{ project.description }}</small>
          </td>
          <td><code>{{ project.customerId }}</code></td>
          <td>{{ statusLabel(project.status) }}</td>
          <td>${{ project.budget | number: '1.0-2' }}</td>
          <td>{{ project.startDate | date: 'mediumDate' }}</td>
          <td>{{ project.endDate ? (project.endDate | date: 'mediumDate') : '-' }}</td>
          <td class="text-end">
            <button type="button" class="btn btn-outline-primary btn-sm me-1" (click)="openEditModal(project)">Edit</button>
            <button
              type="button"
              class="btn btn-outline-warning btn-sm me-1"
              (click)="quickToggleHold(project)">
              {{ project.status === 2 ? 'Pause' : 'Resume' }}
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" (click)="delete(project)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end mt-3" *ngIf="!isLoading && !hasError && totalCount > pageSize">
    <button type="button" class="btn btn-sm btn-light me-1" (click)="onPageChanged(-1)">Prev</button>
    <button type="button" class="btn btn-sm btn-light" (click)="onPageChanged(1)">Next</button>
  </div>
</div>

<div class="modal d-block" tabindex="-1" *ngIf="modalVisible">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editingProjectId ? 'Edit Project' : 'New Project' }}</h5>
        <button type="button" class="btn-close" [disabled]="isSaving" (click)="closeModal()"></button>
      </div>

      <form [formGroup]="form" (ngSubmit)="save()">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Customer Id</label>
              <input class="form-control" formControlName="customerId" placeholder="GUID" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" formControlName="status">
                <option *ngFor="let option of statusOptions" [ngValue]="option.value">{{ option.label }}</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Project Name</label>
              <input class="form-control" formControlName="name" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Budget</label>
              <input class="form-control" type="number" min="0" formControlName="budget" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Start Date</label>
              <input class="form-control" type="date" formControlName="startDate" />
            </div>
            <div class="col-md-6">
              <label class="form-label">End Date</label>
              <input class="form-control" type="date" formControlName="endDate" />
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" rows="3" formControlName="description"></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" [disabled]="isSaving" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="isSaving">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
