<div class="page-shell">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Invoices</h2>
    <button type="button" class="btn btn-primary" (click)="openCreateModal()">New Invoice</button>
  </div>

  <div class="card-shell mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Filter</label>
        <input class="form-control" [(ngModel)]="filter" placeholder="Invoice number" />
      </div>

      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select class="form-select" [(ngModel)]="statusFilter">
          <option [ngValue]="undefined">All statuses</option>
          <option *ngFor="let option of statusOptions" [ngValue]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <div class="col-md-3">
        <button type="button" class="btn btn-outline-primary me-2" (click)="pageIndex = 0; load()">Apply</button>
        <button type="button" class="btn btn-outline-secondary" (click)="filter = ''; statusFilter = undefined; pageIndex = 0; load()">
          Reset
        </button>
      </div>
    </div>
  </div>

  <app-loading-state *ngIf="isLoading" message="invoices"></app-loading-state>
  <app-error-state *ngIf="hasError" (retry)="load()"></app-error-state>

  <app-empty-state
    *ngIf="!isLoading && !hasError && invoices.length === 0"
    message="No invoices found for this filter">
  </app-empty-state>

  <div class="card-shell table-responsive" *ngIf="!isLoading && !hasError && invoices.length > 0">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>Invoice No.</th>
          <th>Customer Id</th>
          <th>Project Id</th>
          <th>Issue Date</th>
          <th>Due Date</th>
          <th>Total</th>
          <th>Status</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of invoices; trackBy: trackByInvoice">
          <td class="fw-semibold">{{ invoice.invoiceNumber }}</td>
          <td><code>{{ invoice.customerId }}</code></td>
          <td><code>{{ invoice.projectId || '-' }}</code></td>
          <td>{{ invoice.issueDate | date: 'mediumDate' }}</td>
          <td>{{ invoice.dueDate | date: 'mediumDate' }}</td>
          <td>${{ invoice.totalAmount | number: '1.0-2' }}</td>
          <td>{{ statusLabel(invoice.status) }}</td>
          <td class="text-end">
            <button type="button" class="btn btn-outline-primary btn-sm me-1" (click)="openEditModal(invoice)">Edit</button>
            <button type="button" class="btn btn-outline-success btn-sm me-1" (click)="changeStatus(invoice, 4)">Mark Paid</button>
            <button type="button" class="btn btn-outline-danger btn-sm" (click)="delete(invoice)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end mt-3" *ngIf="!isLoading && !hasError && totalCount > pageSize">
    <button type="button" class="btn btn-sm btn-light me-1" (click)="onPageChanged(-1)">Prev</button>
    <button type="button" class="btn btn-sm btn-light" (click)="onPageChanged(1)">Next</button>
  </div>
</div>

<div class="modal d-block" tabindex="-1" *ngIf="modalVisible">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editingInvoiceId ? 'Edit Invoice' : 'New Invoice' }}</h5>
        <button type="button" class="btn-close" [disabled]="isSaving" (click)="closeModal()"></button>
      </div>

      <form [formGroup]="form" (ngSubmit)="save()">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Customer Id</label>
              <input class="form-control" formControlName="customerId" placeholder="GUID" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Project Id (optional)</label>
              <input class="form-control" formControlName="projectId" placeholder="GUID" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Invoice Number</label>
              <input class="form-control" formControlName="invoiceNumber" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" formControlName="status">
                <option *ngFor="let option of statusOptions" [ngValue]="option.value">{{ option.label }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Issue Date</label>
              <input class="form-control" type="date" formControlName="issueDate" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Due Date</label>
              <input class="form-control" type="date" formControlName="dueDate" />
            </div>
            <div class="col-md-2">
              <label class="form-label">SubTotal</label>
              <input class="form-control" type="number" min="0" formControlName="subTotal" />
            </div>
            <div class="col-md-2">
              <label class="form-label">Tax</label>
              <input class="form-control" type="number" min="0" formControlName="taxAmount" />
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" [disabled]="isSaving" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="isSaving">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
